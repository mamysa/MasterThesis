\section{Ellipsis Depth Checking}

\subsection{Motivation}

Pattern-variables with the same symbol should be under a consistent number of ellipses. For example, in pattern \texttt{(((n\_1 ...) n\_1) ...)} the pattern variable \texttt{n\_1} is not under consistent number of ellipses - one has \textit{ellipsis depth} of one, whereas the other is two. Such invalid patterns should be reported during the compilation process.

In addition, since after pattern matching pattern-variables are plugged into term-termplates, ellipsis depth of each pattern-variable is needed to ensure that given term-template is well-formed.

\subsection{Pattern Traversal}

During pattern traversal, need to maintain the following:

\begin{enumerate}
\item
Let $n$ be \textbf{number of ellipses} on the path from the root of the pattern to some child sub-pattern. $n$ is modified accordingly when visiting patterns of king \RepeatNoArg.

\item Association between pattern-variable $pv$ and its ellipsis depth $d$. Let $E=\emptyset$ containing pairs $(pv, d)$. 
\end{enumerate}

Give some pattern $p$, \Visit{$p$}. The following kinds of $p$ are of interest.
\begin{itemize}
\item $p=$\PatternRepeat. Let $n=n+1$, \Visit{$p_r$}, and then let $n=n-1$.
\item $p$=\BuiltInPattern Check if there exists pair $(pv, d) \in E$. If it does not, $E = E \cup \{ (pv, d) \}$. Otherwise, if $n \neq d$, then $pv$ has inconsistent ellipsis depth and an Exception is raised.
\item $p$=\NonTerminal is handled in the same way as \BuiltInPatternNoArg.
\end{itemize}

Finally, need to annotate pattern $p$ with $E$ - \MakeAnnotation{$p$}{"EllipsisDepths"}{$E$}.

\subsection{Example}

TODO
